# Implementation Notes 3.実装メモ

# Raspberry Pi フォトフレームプロジェクト

## 1. プロジェクト概要

本プロジェクトは、Raspberry Pi 4 を用いてフォトフレーム機能と写真撮影機能を統合したデバイスを構築するものです。ユーザーは音声コマンドや笑顔検出を通じて写真を撮影し、それらの写真をスライドショー形式で表示することができます。また、Wi-Fi 接続を通じてウェブインターフェースや Samba を利用し、写真の管理や設定変更を行うことができます。

## 2. モジュールの詳細設計

### 2.1 main.py

**概要:**

* システムのエントリーポイント。
* 各機能モジュール（スライドショー、音声コマンド、アクティビティ監視）をマルチスレッドで実行。

**主な関数とクラス:**

* `main()`: プログラムの開始点。設定の読み込みと各スレッドの起動を行う。
* `command_listener(config)`: 音声コマンドのリスニングを行う無限ループ。
* `start_slideshow(config)`: フォトフレームモードを開始。
* `monitor_activity(config)`: ユーザーの操作を監視し、無操作時間を計測。

**注意点:**

* スレッド間のリソース共有に注意。必要に応じてロック機構を使用する。
* スレッドの例外処理を適切に行い、予期しない終了を防ぐ。

### 2.2 utils.py

**概要:**

* 共通機能やヘルパー関数をまとめたモジュール。
* 設定ファイルの読み込みや環境変数の展開を行う。

**主な関数:**

* `load_config(config_path)`: config.yaml を読み込み、環境変数を展開して辞書型で返す。

**注意点:**

* `.env` ファイルから環境変数を読み込むため、python-dotenv ライブラリを使用。

### 2.3 photoframe_tkinter.py

**概要:**

* tkinter を使用してスライドショーを表示。
* 全画面表示で指定ディレクトリ内の画像を順次表示。

**主なクラス:**

* `PhotoFrame`: tkinter の Tk クラスを継承。スライドショーのロジックを実装。

**主なメソッド:**

* `__init__(self, photo_directory, interval)`: 初期化処理。画像の読み込みと UI 設定。
* `load_photos(self)`: 指定ディレクトリから画像ファイルをリストで取得。
* `show_photo(self)`: 現在の画像を表示し、次の画像を表示するためにタイマーをセット。

**注意点:**

* 画像のリサイズ処理でメモリ使用量が増加する可能性があるため、適切なサイズにリサイズする。
* `ImageTk.PhotoImage` の参照を保持しないと画像が表示されないため、`self.label.image = photo` で参照を維持。

### 2.4 photo_capture.py

**概要:**

* Raspberry Pi カメラを使用して写真を撮影。
* 撮影した画像を指定ディレクトリに保存。

**主な関数:**

* `capture_photo(photo_directory)`: カメラを起動し、写真を撮影して保存。

**注意点:**

* カメラ起動後、`time.sleep(2)` でカメラの調整時間を確保。
* カメラリソースの解放を忘れないように `with` ステートメントを使用。

**技術的決定:**

* picamera ライブラリを使用することで、Raspberry Pi カメラの操作が容易になる。

### 2.5 voice_commands.py

**概要:**

* 音声コマンドの認識と処理を担当。
* 音声入力をテキストに変換し、コマンドに応じた処理を行う。

**主な関数:**

* `listen_for_commands()`: マイクから音声を取得し、Google の音声認識 API を使用してテキストに変換。
* `process_command(command, config)`: 認識されたコマンドに応じて機能を実行。
* `countdown(seconds)`: 撮影前のカウントダウンを表示。

**注意点:**

* ネットワーク接続が必要なため、オフライン環境では動作しない。
* 誤認識を減らすために、環境ノイズの除去やマイクの感度調整が必要。

**技術的決定:**

* SpeechRecognition ライブラリを使用し、認識精度の高い Google API を採用。

### 2.6 smile_detection.py

**概要:**

* カメラ映像から笑顔を検出し、自動的に写真を撮影。
* OpenCV の顔・笑顔検出機能を利用。

**主な関数:**

* `detect_smile_and_capture(camera_index, save_path)`: カメラから映像を取得し、笑顔が検出されたら写真を撮影。

**注意点:**

* カスケード分類器のパラメータ（スケールファクターや近傍数）を調整し、検出精度を最適化。
* 処理負荷が高いため、デバイスのパフォーマンスに注意。

**技術的決定:**

* OpenCV の haarcascade を使用することで、比較的簡単に顔・笑顔検出が可能。

### 2.7 web_app.py

**概要:**

* Flask を使用してウェブインターフェースを提供。
* 写真のアップロード・ダウンロード、ダッシュボードの表示を行う。

**主なルート:**

* `/`: ダッシュボードページ。アップロードされた写真の一覧を表示。
* `/upload`: 写真のアップロード処理。
* `/download/<filename>`: 写真のダウンロード処理。

**認証:**

* Flask-HTTPAuth を使用して基本認証を実装。
* ユーザー名とパスワードはハッシュ化して users 辞書で管理。

**注意点:**

* ファイルの保存・読み込み時にパスインジェクションの脆弱性がないように注意。
* 大量の写真がある場合、ページネーションの実装を検討。

**技術的決定:**

* 軽量なウェブフレームワークである Flask を採用し、シンプルな構成に。


## 3. 技術的な決定理由と注意点

### 3.1 ライブラリ選定

* **OpenCV:** 画像処理と顔・笑顔検出に必要な機能が豊富であり、コミュニティサポートも充実しているため。
* **SpeechRecognition:** 複数の音声認識 API をサポートしており、実装が容易であるため。
* **Flask:** 軽量で学習コストが低く、シンプルなウェブアプリケーションに適しているため。
* **Pillow:** 画像のリサイズや形式変換などの基本的な画像処理が可能。

### 3.2 マルチスレッドの採用

* スライドショー表示、音声コマンドのリスニング、ユーザーアクティビティの監視を同時に行う必要があるため、マルチスレッドを採用。
* GIL（Global Interpreter Lock）の影響で CPU バウンドな処理には制約があるが、I/O バウンドな処理が多いため問題なし。

### 3.3 セキュリティ対策

* **基本認証の実装:** ウェブインターフェースへの不正アクセスを防ぐため、Flask-HTTPAuth を使用。
* **パスワードのハッシュ化:** `werkzeug.security` の `generate_password_hash` と `check_password_hash` を使用。
* **SSL/TLS の導入:** 通信の暗号化により、データの盗聴や改ざんを防止。

## 4. 設定ファイルの詳細説明

### 4.1 config.yaml

`config.yaml` はシステム全体の設定を管理します。環境変数を利用して値を動的に設定できます。

```yaml
# スライドショー設定
slideshow:
  interval: ${SLIDESHOW_INTERVAL}  # 表示間隔（ミリ秒）
  timeout: ${SLIDESHOW_TIMEOUT}    # 無操作時間（秒）
  photos_directory: ${PHOTOS_DIRECTORY}  # フォトディレクトリのパス

# カメラ設定
camera:
  resolution: ${CAMERA_RESOLUTION}  # 解像度（例："1920x1080")

# Samba 設定
samba:
  user: ${SAMBA_USER}
  password: ${SAMBA_PASSWORD}

# Flask 設定
flask:
  host: ${FLASK_HOST}
  port: ${FLASK_PORT}
  debug: ${FLASK_DEBUG}

# 環境設定
environment: ${ENVIRONMENT} 
```

**各パラメータの説明:**

* `slideshow.interval`: スライドショーで各画像を表示する間隔（ミリ秒単位）。
* `slideshow.timeout`: ユーザーの無操作時間がこの値を超えると、フォトフレームモードに自動的に切り替わる（秒単位）。
* `slideshow.photos_directory`: スライドショーで表示する写真が保存されているディレクトリのパス。
* `camera.resolution`: 写真撮影時の解像度（幅 x 高さ）。
* `samba.user` / `samba.password`: Samba 共有に使用するユーザー名とパスワード。
* `flask.host` / `flask.port` / `flask.debug`: Flask アプリケーションのホスト、ポート、デバッグモードの設定。
* `environment`: アプリケーションの実行環境（例：production、development）。

### 4.2 .env

`.env` ファイルは環境変数を定義し、`config.yaml` で使用されます。

```bash
# .env ファイル
FLASK_HOST=0.0.0.0
FLASK_PORT=5000
FLASK_DEBUG=False

SLIDESHOW_INTERVAL=5000  # 表示間隔（ミリ秒）
SLIDESHOW_TIMEOUT=60      # 無操作時間（秒）
PHOTOS_DIRECTORY="/home/pi/photos"

CAMERA_RESOLUTION="1920x1080"

SAMBA_USER="pi"
SAMBA_PASSWORD="your_strong_password"

ENVIRONMENT="production" 
```


## 5. 今後の改善点と TODO リスト

* **顔認識の精度向上:** 現在は Haar Cascade を使用しているが、より高精度な DNN ベースのモデル（例：dlib や OpenCV DNN）への移行を検討。
* **オフライン音声認識の実装:** 現在の音声認識はオンライン環境が必要。PocketSphinx などのオフライン音声認識ライブラリの導入を検討。
* **ウェブインターフェースの強化:** 写真の削除機能や設定変更機能の追加。
* **ユーザーインターフェースの改善:** GUI デザインを改善し、ユーザビリティを向上。
* **エラーハンドリングの強化:** 例外処理を充実させ、システムの安定性を向上。
* **ロギング機能の実装:** ログレベルの設定やログの保存先を柔軟に変更できるようにする。


## 6. 既知のバグと制約事項

* **音声認識の誤認識:** 環境ノイズやマイクの性能により、音声コマンドが正しく認識されない場合がある。
* **処理遅延:** Raspberry Pi の性能上、笑顔検出時にフレームレートが低下することがある。
* **カメラ接続の不安定性:** カメラモジュールが正しく接続されていない場合、プログラムがクラッシュする。
* **ウェブインターフェースのセキュリティ:** 現在は基本認証のみのため、さらなるセキュリティ強化が必要。


## 7. トラブルシューティング

### 7.1 カメラが起動しない

**原因:**

* カメラモジュールの接続不良。
* カメラが他のプロセスで使用中。

**対策:**

* Raspberry Pi をシャットダウンし、カメラケーブルの接続を確認。
* `sudo raspi-config` でカメラが有効になっているか確認。
* `lsof /dev/video0` でカメラデバイスを使用しているプロセスを特定し、終了させる。


### 7.2 音声認識が動作しない

**原因:**

* マイクが正しく接続されていない。
* ネットワーク接続がない。

**対策:**

* マイクが認識されているか `arecord -l` で確認。
* インターネットに接続されているか確認。


### 7.3 ウェブインターフェースにアクセスできない

**原因:**

* Flask アプリケーションが起動していない。
* ファイアウォール設定でポートがブロックされている。

**対策:**

* `sudo systemctl status photo_frame.service` でサービスの状態を確認。
* `sudo ufw status` でポート 5000 が許可されているか確認。


## 8. パフォーマンスチューニング

### 8.1 OpenCV の最適化

* **ビルドの最適化:** OpenCV をソースからビルドし、NEON や VFPV3 などの最適化を有効化。
* **解像度の調整:** 処理する画像の解像度を下げることで、処理速度を向上。


### 8.2 マルチプロセッシングの検討

* CPU バウンドな処理（例：笑顔検出）を別プロセスで実行し、GIL の影響を回避。


### 8.3 キャッシュの活用

* 頻繁にアクセスするデータ（例：設定情報や画像リスト）をメモリにキャッシュ。


## 9. テスト結果の概要

### 9.1 機能テスト

* **スライドショー表示:** 正常に画像が表示され、指定した間隔で切り替わることを確認。
* **写真撮影機能:** 音声コマンドおよび笑顔検出での撮影が成功。
* **音声認識:** 環境ノイズが少ない場合、高い精度で認識。
* **ウェブインターフェース:** 写真のアップロード・ダウンロードが正常に行える。


### 9.2 性能テスト

* **笑顔検出のフレームレート:** 平均 5〜10 FPS。
* **音声認識の応答速度:** 平均 3 秒以内。


### 9.3 セキュリティテスト

* **未認証アクセスの試行:** 基本認証によりブロックされることを確認。
* **パスワードのブルートフォース対策:** 現在は未実装のため、今後の課題。